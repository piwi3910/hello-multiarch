arch:
  - amd64
  - arm64
os:
  - linux

language: ruby
dist: xenial

services:
  - docker

env:
  global:
    - DOCKER_REPO="piwi3910/hello-multiarch"
    - GIT_SHA="$(git rev-parse --short HEAD)"

jobs:
  include:
    - os: linux
      arch: amd64
    - os: linux
      arch: arm64
    - stage: Build
      script:
        - docker build --pull --tag "${DOCKER_REPO}:${GIT_SHA}" .
        - echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin &> /dev/null
        - docker push "${DOCKER_REPO}:${GIT_SHA}"

    - stage: Testing
      script:
        - docker pull "${DOCKER_REPO}:${GIT_SHA}"
        - docker run "${DOCKER_REPO}:${GIT_SHA}"

    - stage: Publish
      script:
        - echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin &> /dev/null
        - docker pull "${DOCKER_REPO}:${GIT_SHA}"
        - docker tag "${DOCKER_REPO}:${GIT_SHA}" "${DOCKER_REPO}:latest"
        - docker push "${DOCKER_REPO}:latest"
